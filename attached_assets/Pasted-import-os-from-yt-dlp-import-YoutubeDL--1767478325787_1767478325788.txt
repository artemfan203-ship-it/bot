import os
from yt_dlp import YoutubeDL

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Å–∫–∞—á—É–≤–∞–Ω–Ω—è (–¥–æ–¥–∞–π —Ü–µ –Ω–∞ –ø–æ—á–∞—Ç–∫—É –∞–±–æ –≤ –æ–∫—Ä–µ–º–∏–π —Ñ–∞–π–ª)
async def download_song(query):
    ydl_opts = {
        'format': 'bestaudio/best',
        'outtmpl': 'downloads/%(id)s.%(ext)s', # –ö—É–¥–∏ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏
        'postprocessors': [{
            'key': 'FFmpegExtractAudio',
            'preferredcodec': 'mp3',
            'preferredquality': '192',
        }],
        'noplaylist': True,
        'quiet': True
    }

    try:
        with YoutubeDL(ydl_opts) as ydl:
            # 1. –®—É–∫–∞—î–º–æ –≤—ñ–¥–µ–æ
            info = ydl.extract_info(f"ytsearch:{query}", download=False)['entries'][0]
            video_id = info['id']
            title = info['title']
            url = info['webpage_url']
            
            # 2. –°–∫–∞—á—É—î–º–æ
            ydl.download([url])
            
            return {
                'title': title,
                'path': f"downloads/{video_id}.mp3",
                'url': url
            }
    except Exception as e:
        print(f"Error: {e}")
        return None

# --- –û–Ω–æ–≤–ª–µ–Ω–∏–π —Ö–µ–Ω–¥–ª–µ—Ä –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ—à—É–∫—É ---
# –ó–∞–º—ñ–Ω–∏ —Å—Ç–∞—Ä–∏–π —Ö–µ–Ω–¥–ª–µ—Ä @dp.message(F.text) –Ω–∞ —Ü–µ–π:

@dp.message(F.text)
async def text_search_and_download(message: types.Message):
    # –Ü–≥–Ω–æ—Ä—É—î–º–æ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é, —â–æ–± –Ω–µ —à—É–∫–∞–≤ "–ü—Ä–æ—Ñ—ñ–ª—å" —è–∫ –ø—ñ—Å–Ω—é
    if message.text in ["üéµ –ü–æ—à—É–∫ –º—É–∑–∏–∫–∏", "üìª –†–∞–¥—ñ–æ", "üë§ –ü—Ä–æ—Ñ—ñ–ª—å", "‚ÑπÔ∏è –Ü–Ω—Ñ–æ", "üìª –†–∞–¥—ñ–æ –®–∞–Ω—Å–æ–Ω", "üìª –†–∞–¥—ñ–æ –£–∫—Ä–∞—ó–Ω–∞", "üîô –ù–∞–∑–∞–¥"]:
        return

    query = message.text
    await message.answer(f"üîé –®—É–∫–∞—é —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é: {query}...\n–¶–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ —Ç—Ä–æ—Ö–∏ —á–∞—Å—É ‚è≥")
    
    song_data = await download_song(query)
    
    if song_data and os.path.exists(song_data['path']):
        try:
            audio_file = FSInputFile(song_data['path'])
            await message.answer_audio(
                audio_file, 
                caption=f"üéß **{song_data['title']}**\nü§ñ –ó–Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–µ–∑ YouTube",
                parse_mode="Markdown"
            )
        finally:
            # –í–∏–¥–∞–ª—è—î–º–æ —Ñ–∞–π–ª –ø—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏, —â–æ–± –Ω–µ –∑–∞–±–∏–≤–∞—Ç–∏ –ø–∞–º'—è—Ç—å
            os.remove(song_data['path'])
    else:
        await message.answer("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ü—é –ø—ñ—Å–Ω—é.")