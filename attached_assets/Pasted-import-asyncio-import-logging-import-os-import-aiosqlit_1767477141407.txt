import asyncio
import logging
import os
import aiosqlite
from aiogram import Bot, Dispatcher, F, types
from aiogram.filters import CommandStart, Command
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, FSInputFile, URLInputFile
from shazamio import Shazam

# --- –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø ---
BOT_TOKEN = "–¢–í–Ü–ô_–¢–û–ö–ï–ù_–¢–£–¢"  # –í—Å—Ç–∞–≤ —Å—é–¥–∏ —Ç–æ–∫–µ–Ω –≤—ñ–¥ BotFather
DB_NAME = "music_bot.db"

# –õ–æ–≥—É–≤–∞–Ω–Ω—è
logging.basicConfig(level=logging.INFO)

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()
shazam = Shazam()

# --- –ö–õ–ê–í–Ü–ê–¢–£–†–ò ---
main_kb = ReplyKeyboardMarkup(keyboard=[
    [KeyboardButton(text="üéµ –ü–æ—à—É–∫ –º—É–∑–∏–∫–∏"), KeyboardButton(text="üìª –†–∞–¥—ñ–æ")],
    [KeyboardButton(text="üë§ –ü—Ä–æ—Ñ—ñ–ª—å"), KeyboardButton(text="‚ÑπÔ∏è –Ü–Ω—Ñ–æ")]
], resize_keyboard=True)

radio_kb = ReplyKeyboardMarkup(keyboard=[
    [KeyboardButton(text="üìª –†–∞–¥—ñ–æ –®–∞–Ω—Å–æ–Ω"), KeyboardButton(text="üìª –†–∞–¥—ñ–æ –£–∫—Ä–∞—ó–Ω–∞")],
    [KeyboardButton(text="üîô –ù–∞–∑–∞–¥")]
], resize_keyboard=True)

# --- –ë–ê–ó–ê –î–ê–ù–ò–• (–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞) ---
async def init_db():
    async with aiosqlite.connect(DB_NAME) as db:
        # –¢–∞–±–ª–∏—Ü—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        await db.execute('''CREATE TABLE IF NOT EXISTS users 
                            (user_id INTEGER PRIMARY KEY, username TEXT, referrer_id INTEGER)''')
        await db.commit()

async def add_user(user_id, username, referrer_id=None):
    async with aiosqlite.connect(DB_NAME) as db:
        try:
            await db.execute("INSERT INTO users (user_id, username, referrer_id) VALUES (?, ?, ?)", 
                             (user_id, username, referrer_id))
            await db.commit()
            return True # –ù–æ–≤–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á
        except aiosqlite.IntegrityError:
            return False # –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ —î

async def get_friends_count(user_id):
    async with aiosqlite.connect(DB_NAME) as db:
        cursor = await db.execute("SELECT COUNT(*) FROM users WHERE referrer_id = ?", (user_id,))
        count = await cursor.fetchone()
        return count[0]

# --- –û–ë–†–û–ë–ù–ò–ö–ò –ö–û–ú–ê–ù–î (HANDLERS) ---

@dp.message(CommandStart())
async def cmd_start(message: types.Message):
    user_id = message.from_user.id
    username = message.from_user.username or "–ù–µ–≤—ñ–¥–æ–º–∏–π"
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏ (–¥—Ä—É–∑—ñ)
    args = message.text.split()
    referrer_id = None
    if len(args) > 1:
        try:
            referrer_id = int(args[1])
            if referrer_id == user_id: 
                referrer_id = None # –ù–µ –º–æ–∂–Ω–∞ –∑–∞–ø—Ä–æ—Å–∏—Ç–∏ —Å–∞–º–æ–≥–æ —Å–µ–±–µ
        except ValueError:
            pass

    is_new = await add_user(user_id, username, referrer_id)
    
    welcome_text = (f"–ü—Ä–∏–≤—ñ—Ç, {message.from_user.first_name}!\n"
                    f"–Ø –º—É–∑–∏—á–Ω–∏–π –±–æ—Ç. –Ø –º–æ–∂—É –∑–Ω–∞–π—Ç–∏ –ø—ñ—Å–Ω—é –∑–∞ —Ç–µ–∫—Å—Ç–æ–º –∞–±–æ "
                    f"—Ä–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ —ó—ó –∑ —Ç–≤–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.")
    
    if is_new and referrer_id:
        await bot.send_message(referrer_id, f"üéâ –£ —Ç–µ–±–µ –Ω–æ–≤–∏–π –¥—Ä—É–≥: {message.from_user.first_name}!")

    await message.answer(welcome_text, reply_markup=main_kb)

# --- –†–û–ó–î–Ü–õ: –Ü–ù–§–û ---
@dp.message(F.text == "‚ÑπÔ∏è –Ü–Ω—Ñ–æ")
async def info_section(message: types.Message):
    info_text = (
        "ü§ñ **–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –±–æ—Ç–∞**\n\n"
        "üìú **–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è:**\n"
        "1. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å '–ü–æ—à—É–∫ –º—É–∑–∏–∫–∏' —Ç–∞ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –Ω–∞–∑–≤—É –ø—ñ—Å–Ω—ñ –∞–±–æ —Å–ª–æ–≤–∞.\n"
        "2. –ù–∞–¥—ñ—à–ª—ñ—Ç—å –ì–° (–≥–æ–ª–æ—Å–æ–≤–µ) –∞–±–æ –∫—Ä—É–∂–µ—á–æ–∫ –∑ –º—É–∑–∏–∫–æ—é, —ñ —è —Å–ø—Ä–æ–±—É—é —ó—ó –≤–≥–∞–¥–∞—Ç–∏ (—è–∫ Shazam).\n"
        "3. –°–ª—É—Ö–∞–π—Ç–µ —Ä–∞–¥—ñ–æ —É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ.\n\n"
        "üë®‚Äçüíª **–¢–≤–æ—Ä–µ—Ü—å:** –ê—Ä—Ç–µ–º –ü—Ä–æ—Ü–∫–æ –ê–Ω–¥—Ä—ñ–π–æ–≤–∏—á\n"
        "üí° **–ú–æ—Ç–∏–≤ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è:** –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑—Ä—É—á–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø–æ—à—É–∫—É –º—É–∑–∏–∫–∏ —Ç–∞ –ø–æ–ø—É–ª—è—Ä–∏–∑–∞—Ü—ñ—ó —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É, –æ–±'—î–¥–Ω—É—é—á–∏ –ª—é–¥–µ–π —á–µ—Ä–µ–∑ –º—É–∑–∏—á–Ω—ñ —Å–º–∞–∫–∏.\n"
    )
    await message.answer(info_text, parse_mode="Markdown")

# --- –†–û–ó–î–Ü–õ: –ü–†–û–§–Ü–õ–¨ –¢–ê –î–†–£–ó–Ü ---
@dp.message(F.text == "üë§ –ü—Ä–æ—Ñ—ñ–ª—å")
async def profile_section(message: types.Message):
    user_id = message.from_user.id
    friends_count = await get_friends_count(user_id)
    bot_info = await bot.get_me()
    
    # –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è –¥—Ä—É–∑—ñ–≤
    invite_link = f"https://t.me/{bot_info.username}?start={user_id}"
    
    text = (
        f"üë§ **–¢–≤—ñ–π –ü—Ä–æ—Ñ—ñ–ª—å**\n"
        f"ID: `{user_id}`\n"
        f"–Ü–º'—è: {message.from_user.full_name}\n\n"
        f"üë• **–°–∏—Å—Ç–µ–º–∞ –î—Ä—É–∑—ñ:**\n"
        f"–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø—Ä–æ—à–µ–Ω–∏—Ö –¥—Ä—É–∑—ñ–≤: **{friends_count}**\n\n"
        f"üîó **–¢–≤–æ—î –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è:**\n"
        f"`{invite_link}`\n\n"
        f"_–ù–∞–¥—ñ—à–ª–∏ —Ü–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥—Ä—É–≥—É, —ñ —è–∫—â–æ –≤—ñ–Ω –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞, –≤—ñ–Ω –¥–æ–¥–∞—Å—Ç—å—Å—è —É —Ç–≤—ñ–π —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑—ñ–≤._"
    )
    await message.answer(text, parse_mode="Markdown")

# --- –†–û–ó–î–Ü–õ: –†–ê–î–Ü–û ---
@dp.message(F.text == "üìª –†–∞–¥—ñ–æ")
async def radio_menu(message: types.Message):
    await message.answer("–û–±–µ—Ä–∏ —Ä–∞–¥—ñ–æ—Å—Ç–∞–Ω—Ü—ñ—é:", reply_markup=radio_kb)

@dp.message(F.text == "üìª –†–∞–¥—ñ–æ –®–∞–Ω—Å–æ–Ω")
async def radio_chanson(message: types.Message):
    # –ü—Ä–∏–∫–ª–∞–¥ URL (–º–æ–∂–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏—Å—å, –ø–æ—Ç—Ä—ñ–±–Ω–æ —à—É–∫–∞—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ñ –ø–æ—Ç–æ–∫–∏)
    stream_url = "https://cast.radiogroup.com.ua/chanson" 
    await message.answer("üéß –í–º–∏–∫–∞—é –†–∞–¥—ñ–æ –®–∞–Ω—Å–æ–Ω...")
    await message.answer_audio(URLInputFile(stream_url, filename="RadioChanson.mp3"))

@dp.message(F.text == "üìª –†–∞–¥—ñ–æ –£–∫—Ä–∞—ó–Ω–∞")
async def radio_ukraine(message: types.Message):
    stream_url = "http://ukr.radio:8000/ur1-mp3" # UR-1 –£–∫—Ä–∞—ó–Ω—Å—å–∫–µ —Ä–∞–¥—ñ–æ
    await message.answer("üéß –í–º–∏–∫–∞—é –£–∫—Ä–∞—ó–Ω—Å—å–∫–µ –†–∞–¥—ñ–æ...")
    await message.answer_audio(URLInputFile(stream_url, filename="RadioUkraine.mp3"))

@dp.message(F.text == "üîô –ù–∞–∑–∞–¥")
async def go_back(message: types.Message):
    await message.answer("–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", reply_markup=main_kb)

# --- –†–û–ó–î–Ü–õ: –ü–û–®–£–ö –¢–ê SHAZAM ---
@dp.message(F.text == "üéµ –ü–æ—à—É–∫ –º—É–∑–∏–∫–∏")
async def search_hint(message: types.Message):
    await message.answer("–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –Ω–∞–∑–≤—É –ø—ñ—Å–Ω—ñ –∞–±–æ –Ω–∞–¥—ñ—à–ª–∏ –º–µ–Ω—ñ –≥–æ–ª–æ—Å–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è/–∞—É–¥—ñ–æ—Ñ–∞–π–ª –∑ —É—Ä–∏–≤–∫–æ–º –º—É–∑–∏–∫–∏!")

# –û–±—Ä–æ–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∏—Ö —Ç–∞ –∞—É–¥—ñ–æ (SHAZAM)
@dp.message(F.content_type.in_({types.ContentType.VOICE, types.ContentType.AUDIO}))
async def voice_handler(message: types.Message):
    await message.answer("üîé –°–ª—É—Ö–∞—é... –°–µ–∫—É–Ω–¥–æ—á–∫—É...")
    
    # –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É
    file_id = message.voice.file_id if message.voice else message.audio.file_id
    file = await bot.get_file(file_id)
    file_path = f"temp_{file_id}.ogg"
    
    await bot.download_file(file.file_path, file_path)
    
    try:
        # –†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è
        out = await shazam.recognize(file_path)
        
        if 'track' in out:
            track = out['track']
            title = track['title']
            author = track['subtitle']
            image = track['images']['coverart'] if 'images' in track else None
            link = track['url']
            
            caption = f"üé§ **–ó–Ω–∞–π–¥–µ–Ω–æ!**\n\nüéµ **–¢—Ä–µ–∫:** {title}\nüë§ **–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å:** {author}\nüîó [–°–ª—É—Ö–∞—Ç–∏ –Ω–∞ Shazam]({link})"
            
            if image:
                await message.answer_photo(photo=image, caption=caption, parse_mode="Markdown")
            else:
                await message.answer(caption, parse_mode="Markdown")
                
            # –°–ø—Ä–æ–±–∞ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø—Ä–µ–≤'—é (—è–∫—â–æ —î)
            if 'hub' in track and 'actions' in track['hub']:
                for action in track['hub']['actions']:
                    if action['type'] == 'uri':
                        await message.answer(f"üîó –°—Ç—Ä—ñ–º—ñ–Ω–≥ –ø–æ—Å–∏–ª–∞–Ω–Ω—è: {action['uri']}")
        else:
            await message.answer("üòî –ù–∞ –∂–∞–ª—å, —è –Ω–µ –∑–º—ñ–≥ —Ä–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ —Ü—é –º–µ–ª–æ–¥—ñ—é.")
            
    except Exception as e:
        logging.error(e)
        await message.answer("–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—ñ.")
    finally:
        if os.path.exists(file_path):
            os.remove(file_path)

# –û–±—Ä–æ–±–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ—à—É–∫—É
@dp.message(F.text)
async def text_search(message: types.Message):
    # –ü–æ—à—É–∫ —á–µ—Ä–µ–∑ Shazam API (—Ç–µ–∫—Å—Ç–æ–≤–∏–π)
    query = message.text
    await message.answer(f"üîé –®—É–∫–∞—é: {query}...")
    
    try:
        search_results = await shazam.search_track(query=query, limit=1)
        tracks = search_results.get('tracks', {}).get('hits', [])
        
        if tracks:
            track_data = tracks[0]
            title = track_data['heading']['title']
            subtitle = track_data['heading']['subtitle']
            image = track_data['images']['default']
            
            # –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–µ—Ç–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ –¥–ª—è –ª—ñ–Ω–∫–∞
            key = track_data['key']
            about_track = await shazam.track_about(track_id=key)
            link = about_track.get('url', 'https://shazam.com')

            caption = f"üéß **–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—à—É–∫—É:**\n\nüéµ {title}\nüë§ {subtitle}\nüîó [–í—ñ–¥–∫—Ä–∏—Ç–∏]({link})"
            await message.answer_photo(photo=image, caption=caption, parse_mode="Markdown")
        else:
            await message.answer("–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ —Ü–∏–º –∑–∞–ø–∏—Ç–æ–º.")
            
    except Exception as e:
        logging.error(e)
        await message.answer("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–æ—à—É–∫—É.")

# --- –ó–ê–ü–£–°–ö ---
async def main():
    await init_db()
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ!")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())